<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Batman OBJ+MTL Test – remap maps→textures</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body { height:100%; margin:0; background:#0b0d11; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #error { position:fixed; inset:0; display:none; padding:16px; background:rgba(0,0,0,.85); z-index:9999; overflow:auto; }
    #error h3{margin:0 0 8px 0}
    #error pre{white-space:pre-wrap; word-break:break-word; background:#111; padding:12px; border:1px solid #333; border-radius:8px}
    .badge { position:fixed; top:12px; right:12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); padding:6px 10px; border-radius:10px; font-size:12px; }
    .hint { position:fixed; bottom:12px; left:12px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); padding:6px 10px; border-radius:10px; font-size:12px; }
  </style>
</head>
<body>
  <div class="badge">Batman MTL Test v2</div>
  <div class="hint">Orbit: drej/zoom/pan med musen</div>
  <div id="error"><h3>⚠️ Fejl</h3><div id="em"></div><pre id="es"></pre></div>

  <script type="module">
    import * as THREE from "https://esm.sh/three@0.160.0";
    import { OrbitControls } from "https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { OBJLoader } from "https://esm.sh/three@0.160.0/examples/jsm/loaders/OBJLoader.js";
    import { MTLLoader } from "https://esm.sh/three@0.160.0/examples/jsm/loaders/MTLLoader.js";

    const showErr = (msg, stack="")=>{
      const box = document.getElementById('error');
      document.getElementById('em').textContent = String(msg || "(ukendt fejl)");
      document.getElementById('es').textContent = String(stack || "");
      box.style.display = 'block';
      console.error("[Batman Test] ", msg, stack);
    };
    window.addEventListener('error', e => showErr(e.message, e.error?.stack));
    window.addEventListener('unhandledrejection', e => {
      const r = e.reason || {};
      showErr(r.message || r, r.stack);
    });

    // ---- Scene ----
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.setClearColor(0x0b0d11, 1);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 500);
    camera.position.set(4, 2.2, 5.5);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const sun = new THREE.DirectionalLight(0xffffff, 1.0);
    sun.position.set(5, 8, 5);
    sun.castShadow = true;
    scene.add(sun);

    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(40,40),
      new THREE.MeshStandardMaterial({ color:"#2a2f37", roughness:0.95 })
    );
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    const grid = new THREE.GridHelper(40, 40, 0x3a4150, 0x232833);
    grid.position.y = 0.001;
    scene.add(grid);

    // ---- Remap alle URL’er der går mod /maps/ → /textures/ ----
    const PIX1 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";
    const restoreURL = THREE.DefaultLoadingManager.setURLModifier((url)=>{
      // GitHub Pages fuld URL → strip origin for at matche nemmere
      try {
        const u = new URL(url, location.href);
        url = u.pathname; // relativ sti
      } catch {}
      if (url.includes("/maps/bump/")) return PIX1;                 // neutraliser bump-map
      if (url.includes("/maps/"))      return url.replace("/maps/","/textures/"); // remap til textures/
      return url;
    });

    const mtlLoader = new MTLLoader();
    mtlLoader.setResourcePath("assets/Batman/");
    mtlLoader.load(
      "assets/Batman/Untitled Model.mtl",
      (mtl) => {
        try {
          mtl.preload();
          // Gør alle materials PBR-venlige + DoubleSide + sRGB maps
          Object.values(mtl.materials || {}).forEach(mat=>{
            mat.side = THREE.DoubleSide;
            if (mat.map) {
              mat.map.colorSpace = THREE.SRGBColorSpace;
              mat.map.needsUpdate = true;
            }
            if (mat.emissiveMap) {
              mat.emissiveMap.colorSpace = THREE.SRGBColorSpace;
              mat.emissiveMap.needsUpdate = true;
            }
          });

          const objLoader = new OBJLoader();
          objLoader.setMaterials(mtl);
          objLoader.load(
            "assets/Batman/Untitled Model.obj",
            (obj)=>{
              try {
                // Standardiser + log materialenavne for debugging
                obj.traverse((c)=>{
                  if (!c.isMesh) return;
                  c.castShadow = true; c.receiveShadow = true;
                  c.visible = true;
                  if (c.material) {
                    c.material.side = THREE.DoubleSide;
                    if (c.material.map) {
                      c.material.map.colorSpace = THREE.SRGBColorSpace;
                      c.material.map.needsUpdate = true;
                    }
                    // Debug
                    console.log("[Mat]", c.name, "→", c.material.name || "(no-name)", {
                      hasMap: !!c.material.map
                    });
                  }
                });

                // Skaler til ~1.7 høj
                const box = new THREE.Box3().setFromObject(obj);
                const size = new THREE.Vector3(); box.getSize(size);
                const scale = (size.y > 1e-4) ? (1.7 / size.y) : 1.0;
                obj.scale.setScalar(scale);

                // Fødder på gulv
                const box2 = new THREE.Box3().setFromObject(obj);
                obj.position.y += -box2.min.y;

                // Vend 180°
                obj.rotation.y = Math.PI;

                scene.add(obj);
                console.log("[Batman Test] OBJ+MTL loaded OK");
              } catch (e) {
                showErr("Batman model post-process fejlede", e.stack);
              } finally {
                THREE.DefaultLoadingManager.setURLModifier(null); // restore
              }
            },
            undefined,
            (err)=>{ showErr("OBJ kunne ikke indlæses", String(err)); THREE.DefaultLoadingManager.setURLModifier(null); }
          );
        } catch (e) {
          showErr("MTL post-process fejlede", e.stack);
          THREE.DefaultLoadingManager.setURLModifier(null);
        }
      },
      undefined,
      (err)=>{ showErr("MTL kunne ikke indlæses", String(err)); THREE.DefaultLoadingManager.setURLModifier(null); }
    );

    // Resize + render loop
    addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
    const clock = new THREE.Clock();
    (function loop(){
      clock.getDelta();
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>
