<!doctype html>
<html lang="da">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LEGO Batman – Voxel Builder (Deluxe, Fixed)</title>
    <style>
      html, body, #root { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; color:#fff; }
      .button { padding:8px 12px; border-radius:12px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); color:white; cursor:pointer; }
      .hud { position:absolute; left:50%; transform:translateX(-50%); bottom:16px; display:flex; gap:8px; padding:8px; border-radius:16px; background:rgba(0,0,0,0.35); backdrop-filter: blur(6px); }
      .crosshair { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:16px; height:16px; border-radius:999px; border:1px solid rgba(255,255,255,0.7); pointer-events:none; }
      .topbar { position:absolute; top:16px; left:16px; display:flex; gap:8px; flex-wrap:wrap; }
      .title { position:absolute; top:16px; right:16px; text-align:right; }
      .sidebar { position:absolute; top:0; left:0; height:100%; width:300px; background:rgba(24,24,27,.92); color:#fff; padding:16px; overflow-y:auto; backdrop-filter: blur(6px); box-shadow:0 0 24px rgba(0,0,0,.5); border-right:1px solid rgba(255,255,255,.08)}
      .palette { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
      .palette-item { display:flex; gap:8px; align-items:center; background:rgba(255,255,255,.05); padding:8px; border-radius:12px; border:1px solid rgba(255,255,255,.1); }
      .hint { position:absolute; top:16px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.5); padding:8px 12px; border-radius:12px; font-size:13px; }
      #err { position: absolute; bottom: 10px; left: 10px; right: 10px; background: rgba(255,0,0,.15); color:#fff; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding: 8px; border-radius: 8px; display:none; white-space: pre-wrap;}
      #ok  { position: absolute; top:10px; left:10px; background: rgba(0,255,127,.15); color:#b7ffcf; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 6px 10px; border-radius: 8px; font-size: 12px; display:none; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <div id="err"></div>
    <div id="ok">Loaded OK</div>
    <script>
      const showErr = (msg) => { const el = document.getElementById('err'); el.style.display = 'block'; el.textContent = msg; };
      window.addEventListener('error', e => showErr(String(e.error || e.message || e)));
      window.addEventListener('unhandledrejection', e => showErr(String(e.reason || e)));
      setTimeout(()=>{ const ok=document.getElementById('ok'); if (ok) ok.style.display='inline-block'; }, 300);
    </script>

    <script type="module">
      // Pinned & bundled CDN imports
      import React, { useEffect, useMemo, useRef, useState } from "https://esm.sh/react@18.3.1";
      import { createRoot } from "https://esm.sh/react-dom@18.3.1/client";
      import * as THREE from "https://esm.sh/three@0.160.0";
      import { Canvas, useFrame, useThree } from "https://esm.sh/@react-three/fiber@8.15.16?bundle&deps=react@18.3.1,react-dom@18.3.1,three@0.160.0";
      import { motion as Motion, AnimatePresence } from "https://esm.sh/framer-motion@11.0.0";
      import { Sky, Stars, PointerLockControls } from "https://esm.sh/@react-three/drei@9.92.7?deps=react@18.3.1,react-dom@18.3.1,three@0.160.0";
      // ---------- Utils ----------
      const keyState = new Map();
      const setKey = (code, down) => keyState.set(code.toLowerCase(), down);
      const isDown = (code) => keyState.get(code.toLowerCase()) === true;
      const vec3 = (x=0,y=0,z=0) => ({x,y,z});
      const toKey = (x,y,z) => `${x}|${y}|${z}`;

      const BLOCK_TYPES = [
        { id: "black", label: "Black", color: "#111111" },
        { id: "darkgray", label: "Dark Gray", color: "#3a3a3a" },
        { id: "lightgray", label: "Light Gray", color: "#9aa0a6" },
        { id: "yellow", label: "Yellow", color: "#ffd400" },
        { id: "blue", label: "Blue", color: "#1565c0" },
        { id: "purple", label: "Purple", color: "#6a1b9a" },
        { id: "transparent", label: "Translucent", color: "#a0d8ff", transparent: true, opacity: 0.5 },
      ];
      const DEFAULT_HOTBAR = ["black","darkgray","lightgray","yellow","blue","purple","transparent","black","yellow"];

      // ---------- World ----------
      function Ground({ size = 200 }) {
        const { scene } = useThree();
        useEffect(() => { scene.fog = null; }, [scene]);
        return (
          React.createElement('mesh',{rotation:[ -Math.PI / 2, 0, 0 ], receiveShadow:true},
            React.createElement('planeGeometry',{args:[size, size, size, size]}),
            React.createElement('meshStandardMaterial',{color:"#2a2a2d"})
          )
        );
      }

      function BlockMesh({ position, color, transparent=false, opacity=1 }){
        return React.createElement('group',{position},
          React.createElement('mesh',{castShadow:true,receiveShadow:true},
            React.createElement('boxGeometry',{args:[1,1,1]}),
            React.createElement('meshStandardMaterial',{color,transparent,opacity})
          ),
          [-0.25,0.25].map(sx => [-0.25,0.25].map(sz =>
            React.createElement('mesh',{key:`${sx}-${sz}`,position:[sx,0.55,sz],castShadow:true},
              React.createElement('cylinderGeometry',{args:[0.12,0.12,0.1,16]}),
              React.createElement('meshStandardMaterial',{color,transparent,opacity})
            )
          ))
        );
      }

      function Blocks({ blocks }){
        const items = [...blocks.values()];
        return React.createElement('group',null,
          items.map(({pos, type}) => {
            const bt = BLOCK_TYPES.find(b=>b.id===type) || BLOCK_TYPES[0];
            return React.createElement(BlockMesh, { key:`${pos[0]}|${pos[1]}|${pos[2]}`, position:pos, color:bt.color, transparent:!!bt.transparent, opacity:bt.opacity ?? 1 });
          })
        );
      }

      function BatmanMinifig({ position }){
        const body = "#151515", cowl = "#0d0d0d", belt = "#f1c40f", gray = "#444";
        return React.createElement('group',{position},
          React.createElement('mesh',{position:[ -0.15, 0.25, 0 ], castShadow:true}, React.createElement('boxGeometry',{args:[0.25,0.5,0.35]}), React.createElement('meshStandardMaterial',{color:gray})),
          React.createElement('mesh',{position:[ 0.15, 0.25, 0 ], castShadow:true}, React.createElement('boxGeometry',{args:[0.25,0.5,0.35]}), React.createElement('meshStandardMaterial',{color:gray})),
          React.createElement('mesh',{position:[0, 0.85, 0], castShadow:true}, React.createElement('boxGeometry',{args:[0.6,0.7,0.35]}), React.createElement('meshStandardMaterial',{color:body})),
          React.createElement('mesh',{position:[0, 0.55, 0], castShadow:true}, React.createElement('boxGeometry',{args:[0.62,0.1,0.37]}), React.createElement('meshStandardMaterial',{color:belt})),
          React.createElement('mesh',{position:[ -0.45, 0.85, 0 ], castShadow:true}, React.createElement('boxGeometry',{args:[0.2,0.5,0.2]}), React.createElement('meshStandardMaterial',{color:body})),
          React.createElement('mesh',{position:[ 0.45, 0.85, 0 ], castShadow:true}, React.createElement('boxGeometry',{args:[0.2,0.5,0.2]}), React.createElement('meshStandardMaterial',{color:body})),
          React.createElement('mesh',{position:[0, 1.35, 0], castShadow:true}, React.createElement('boxGeometry',{args:[0.35,0.35,0.3]}), React.createElement('meshStandardMaterial',{color:cowl})),
          React.createElement('mesh',{position:[ -0.12, 1.6, 0 ], castShadow:true}, React.createElement('boxGeometry',{args:[0.07,0.15,0.07]}), React.createElement('meshStandardMaterial',{color:cowl})),
          React.createElement('mesh',{position:[ 0.12, 1.6, 0 ], castShadow:true}, React.createElement('boxGeometry',{args:[0.07,0.15,0.07]}), React.createElement('meshStandardMaterial',{color:cowl})),
          React.createElement('mesh',{position:[0, 0.9, -0.23], castShadow:true}, React.createElement('boxGeometry',{args:[0.6,0.8,0.02]}), React.createElement('meshStandardMaterial',{color:cowl}))
        );
      }

      // ---------- Collision ----------
      let currentYaw = 0;
      function aabbVsBlocks(next, size, blocks){
        const half = { x: size.x/2, y: size.y/2, z: size.z/2 };
        const collides = (p) => {
          const minX = Math.floor(p.x - half.x), maxX = Math.floor(p.x + half.x);
          const minY = Math.floor(p.y - half.y), maxY = Math.floor(p.y + half.y);
          const minZ = Math.floor(p.z - half.z), maxZ = Math.floor(p.z + half.z);
          for (let x=minX; x<=maxX; x++){
            for (let y=minY; y<=maxY; y++){
              for (let z=minZ; z<=maxZ; z++){
                if (blocks.has(`${x}|${y}|${z}`)) return true;
              }
            }
          }
          return false;
        };
        const pos = { ...next };
        const tryX = { x: pos.x, y: pos.y, z: pos.z };
        if (collides(tryX)){
          const dir = Math.sign(tryX.x - Math.round(tryX.x));
          while (collides(tryX)) tryX.x += (dir===0? (pos.x>=0?1:-1):dir) * 0.01;
        }
        pos.x = tryX.x;
        const tryZ = { x: pos.x, y: pos.y, z: pos.z };
        if (collides(tryZ)){
          const dir = Math.sign(tryZ.z - Math.round(tryZ.z));
          while (collides(tryZ)) tryZ.z += (dir===0? (pos.z>=0?1:-1):dir) * 0.01;
        }
        pos.z = tryZ.z;
        const tryY = { x: pos.x, y: pos.y, z: pos.z };
        if (collides(tryY)){
          const dir = Math.sign(tryY.y - Math.round(tryY.y));
          while (collides(tryY)) tryY.y += (dir===0?1:dir) * 0.01;
        }
        pos.y = tryY.y;
        return pos;
      }

      // ---------- Player ----------
      function PlayerController({ positionRef, blocks, firstPerson }){
        const ref = useRef(null);
        const vel = useRef(vec3(0,0,0));
        const onGround = useRef(true);

        useEffect(() => {
          const onKeyDown = (e) => {
            if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," ","w","a","s","d","b","1","2","3","4","5","6","7","8","9","f1","q","e"].includes(e.key.toLowerCase()) || e.key === " ") {
              e.preventDefault();
            }
            setKey(e.key, true);
          };
          const onKeyUp = (e) => setKey(e.key, false);
          window.addEventListener("keydown", onKeyDown, { passive: false });
          window.addEventListener("keyup", onKeyUp);
          return () => {
            window.removeEventListener("keydown", onKeyDown);
            window.removeEventListener("keyup", onKeyUp);
          };
        }, []);

        useFrame((_, dt) => {
          const speed = 3.6, jumpV = 6.2;
          let forward = 0, strafe = 0;
          if (isDown("arrowup") || isDown("w")) forward += 1;
          if (isDown("arrowdown") || isDown("s")) forward -= 1;
          if (isDown("arrowleft") || isDown("a")) strafe -= 1;
          if (isDown("arrowright") || isDown("d")) strafe += 1;

          if (!firstPerson){
            if (isDown("arrowleft") && !isDown("a")) currentYaw += 1.5 * dt;
            if (isDown("arrowright") && !isDown("d")) currentYaw -= 1.5 * dt;
          }

          // Retning baseret på yaw (3rd person) eller kamera (1st person styres af pointer lock)
          const yaw = currentYaw;
          const dir = new THREE.Vector3(strafe, 0, -forward);
          if (dir.lengthSq()>0) dir.normalize();
          dir.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);

          const v = vel.current;
          v.x = dir.x * speed; v.z = dir.z * speed; v.y += -9.8 * dt;

          if (onGround.current && (isDown(" ") || isDown("space"))) { v.y = jumpV; onGround.current = false; }

          const p = positionRef.current;
          const next = { x: p.x + v.x * dt, y: p.y + v.y * dt, z: p.z + v.z * dt };
          const resolved = aabbVsBlocks(next, {x:0.6,y:1.7,z:0.6}, blocks);

          if (resolved.y <= 0.5) { resolved.y = 0.5; v.y = 0; onGround.current = true; }
          if (Math.abs(resolved.y - p.y) < 1e-3 && v.y < 0) { v.y = 0; onGround.current = true; }

          p.x = resolved.x; p.y = resolved.y; p.z = resolved.z;

          if (ref.current) { ref.current.position.set(p.x, p.y, p.z); if (!firstPerson) ref.current.rotation.y = yaw; }
        });

        return React.createElement('group',{ref},
          !firstPerson && React.createElement(BatmanMinifig,{position:[0,0,0]})
        );
      }

      // ---------- Camera rig (1st/3rd person) ----------
      function CameraRig({ playerPosRef, firstPerson }){
        const { camera } = useThree();
        useFrame(() => {
          const p = playerPosRef.current;
          if (firstPerson){
            // 1st person: hovedhøjde
            camera.position.set(p.x, p.y + 1.6, p.z);
          } else {
            // 3rd person: offset bagved og lidt oppe
            const offset = new THREE.Vector3(0, 1.8, 4).applyAxisAngle(new THREE.Vector3(0,1,0), currentYaw);
            const target = new THREE.Vector3(p.x, p.y + 0.9, p.z);
            const desired = target.clone().add(offset);
            camera.position.lerp(desired, 0.18);
            camera.lookAt(target);
          }
        });
        return null;
      }

      // ---------- Build / Raycast ----------
      function RaycastPlacer({ mode, blocks, setBlocks }){
        const { camera, gl, scene } = useThree();
        const raycaster = useMemo(()=> new THREE.Raycaster(), []);
        const pointer = useMemo(()=> new THREE.Vector2(), []);

        useEffect(() => {
          const onContext = (e) => e.preventDefault();
          gl.domElement.addEventListener("contextmenu", onContext);
          return () => gl.domElement.removeEventListener("contextmenu", onContext);
        }, [gl]);

        const getSelected = (hotbar, selected) => hotbar[selected] ?? "black";

        // Vi læser hotbar/selected fra DOM via dataset (simpelt trick uden prop drilling)
        function currentSelection(){
          const root = document.getElementById('root');
          const hotbar = (root.dataset.hotbar || "").split(",");
          const selected = parseInt(root.dataset.selected || "0", 10) || 0;
          return getSelected(hotbar, selected);
        }

        const handlePointerDown = (e) => {
          if (mode !== "build") return;
          const rect = gl.domElement.getBoundingClientRect();
          pointer.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
          pointer.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
          raycaster.setFromCamera(pointer, camera);

          // Saml kandidat-objekter (block groups)
          const blockMeshes = [];
          scene.traverse(obj => {
            if (obj.type === "Group" && obj.children?.length) blockMeshes.push(obj);
          });

          const intersectsBlocks = raycaster.intersectObjects(blockMeshes, true);

          if (e.button === 2) {
            // Højreklik = fjern
            if (intersectsBlocks.length > 0) {
              const parent = intersectsBlocks[0].object.parent;
              const pos = parent.position;
              const key = toKey(Math.round(pos.x), Math.round(pos.y), Math.round(pos.z));
              setBlocks(prev => { const m = new Map(prev); m.delete(key); return m; });
              return;
            }
          } else {
            // Venstreklik = placer
            if (intersectsBlocks.length > 0) {
              const hit = intersectsBlocks[0];
              const normal = hit.face?.normal?.clone() ?? new THREE.Vector3(0,1,0);
              const worldNormal = normal.applyMatrix3(new THREE.Matrix3().getNormalMatrix(hit.object.matrixWorld)).normalize();
              const place = hit.point.clone().add(worldNormal.multiplyScalar(0.5)).floor().addScalar(0.5);
              const key = toKey(Math.round(place.x), Math.round(place.y), Math.round(place.z));
              const sel = currentSelection();
              setBlocks(prev => { const m = new Map(prev); if (!m.has(key)) m.set(key, { pos: [Math.round(place.x),Math.round(place.y),Math.round(place.z)], type: sel }); return m; });
              return;
            }
          }

          // Ground
          const ground = new THREE.Plane(new THREE.Vector3(0,1,0), 0);
          const intersection = new THREE.Vector3();
          raycaster.ray.intersectPlane(ground, intersection);
          if (intersection) {
            const place = intersection.clone().add(new THREE.Vector3(0,0.5,0)).floor().addScalar(0.5);
            const key = toKey(Math.round(place.x), Math.round(place.y), Math.round(place.z));
            const sel = currentSelection();
            setBlocks(prev => { const m = new Map(prev); if (!m.has(key)) m.set(key, { pos: [Math.round(place.x), Math.round(place.y), Math.round(place.z)], type: sel }); return m; });
          }
        };

        useEffect(() => {
          const el = gl.domElement;
          el.addEventListener("mousedown", handlePointerDown);
          return () => el.removeEventListener("mousedown", handlePointerDown);
        }, [gl, camera, scene, mode]);

        return null;
      }

      // ---------- BatarangSystem (inde i Canvas) ----------
      function BatarangSystem({ blocks, setBlocks }){
        const { camera } = useThree();
        const [bats, setBats] = useState([]);

        useEffect(() => {
          const onKey = (e) => {
            if (e.key.toLowerCase() === "e"){
              const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion).normalize();
              const pos = camera.position.clone().add(dir.clone().multiplyScalar(0.6)).add(new THREE.Vector3(0,-0.1,0));
              const speed = 12;
              setBats(prev => [...prev, { id: Math.random(), pos, vel: dir.multiplyScalar(speed), ttl: 2.0 }]);
            }
          };
          window.addEventListener("keydown", onKey);
          return () => window.removeEventListener("keydown", onKey);
        }, [camera]);

        useFrame((_, dt) => {
          if (bats.length === 0) return;
          setBats(prev => {
            const next = [];
            for (const b of prev){
              const np = b.pos.clone().add(b.vel.clone().multiplyScalar(dt));
              const cx = Math.round(np.x), cy = Math.round(np.y), cz = Math.round(np.z);
              const key = `${cx}|${cy}|${cz}`;
              let hit = false;
              if (blocks.has(key)){
                hit = true;
                setBlocks((p)=>{ const m = new Map(p); m.delete(key); return m; });
              }
              const nt = b.ttl - dt;
              if (!hit && nt > 0){ next.push({ ...b, pos: np, ttl: nt }); }
            }
            return next;
          });
        });

        return React.createElement('group',null,
          bats.map(b => React.createElement('mesh',{key:b.id, position:b.pos, castShadow:true},
            React.createElement('torusGeometry',{args:[0.15, 0.05, 8, 16]}),
            React.createElement('meshStandardMaterial',{color:"#f1c40f"})
          ))
        );
      }

      // ---------- UI ----------
      function Hotbar({ hotbar, selected, setSelected }){
        useEffect(() => {
          const onKey = (e) => { const n = parseInt(e.key, 10); if (!isNaN(n) && n >= 1 && n <= 9) setSelected(n-1); };
          window.addEventListener("keydown", onKey);
          return () => window.removeEventListener("keydown", onKey);
        }, [setSelected]);
        return React.createElement('div',{className:'hud'},
          hotbar.map((id, i) => {
            const bt = BLOCK_TYPES.find(b=>b.id===id);
            const active = i===selected;
            return React.createElement('button',{
              key:i, title:`${bt.label} (${i+1})`,
              onClick:()=>setSelected(i),
              style:{ width:48, height:48, borderRadius:12, border: active ? "2px solid white" : "1px solid rgba(255,255,255,.3)",
                transform: active ? "scale(1.05)" : "scale(1.0)", background: bt.color, opacity: bt.opacity ?? 1, transition: "transform .15s"}
            });
          })
        );
      }

      function Sidebar({ open, setOpen }){
        useEffect(() => { const onKey = (e) => { if (e.key.toLowerCase() === "b") setOpen(v => !v); }; window.addEventListener("keydown", onKey); return () => window.removeEventListener("keydown", onKey); }, [setOpen]);
        return React.createElement(AnimatePresence, null,
          open && React.createElement(Motion.div, {
            initial:{ x: -320, opacity: 0 },
            animate:{ x: 0, opacity: 1 },
            exit:{ x: -320, opacity: 0 },
            transition:{ type: "spring", damping: 20, stiffness: 240 },
            className: 'sidebar'
          },
            React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}},
              React.createElement('h2',{style:{fontSize:16,fontWeight:600}},'Klodser'),
              React.createElement('button',{className:'button',onClick:()=>setOpen(false)},'Luk (B)')
            ),
            React.createElement('div',{className:'palette'},
              BLOCK_TYPES.map(bt => React.createElement('div',{key:bt.id,className:'palette-item'},
                React.createElement('div',{style:{width:24,height:24,borderRadius:6,background:bt.color,opacity:bt.opacity ?? 1}}),
                React.createElement('div',{style:{fontSize:13}},bt.label)
              ))
            ),
            React.createElement('hr',{style:{borderColor:"rgba(255,255,255,.1)", margin:"16px 0"}}),
            React.createElement('p',{style:{fontSize:12,opacity:.7}},'Tip: 1–9 vælger blok • Højreklik fjerner • Venstreklik placerer • Q skifter tilstand • E kaster batarang • F1: 1st/3rd person (klik i canvas for at låse musen)')
          )
        );
      }

      // ---------- App (DEFINERET) ----------
      function App(){
        const [blocks, setBlocks] = useState(() => {
          const m = new Map();
          for (let x=-6; x<=6; x++) for (let z=-6; z<=6; z++) m.set(`${x}|0|${z}`, { pos:[x,0,z], type: (x+z)%2===0?"darkgray":"lightgray" });
          for (let y=1; y<4; y++) m.set(`2|${y}|2`, { pos:[2,y,2], type: "yellow" });
          return m;
        });
        const [hotbar] = useState([...DEFAULT_HOTBAR]);
        const [selected, setSelected] = useState(0);
        const [sidebarOpen, setSidebarOpen] = useState(true);
        const [mode, setMode] = useState("build");
        const [firstPerson, setFirstPerson] = useState(false);

        // læg hotbar/selected i DOM dataset, så RaycastPlacer kan læse det uden prop-drill
        useEffect(() => {
          const root = document.getElementById('root');
          root.dataset.hotbar = hotbar.join(",");
        }, [hotbar]);
        useEffect(() => {
          const root = document.getElementById('root');
          root.dataset.selected = String(selected);
        }, [selected]);

        const playerPos = useRef(vec3(0,0.5,6));

        // help overlay timeout
        const [showHelp, setShowHelp] = useState(true);
        useEffect(() => { const t = setTimeout(()=>setShowHelp(false), 6000); return () => clearTimeout(t); }, []);
        useEffect(() => {
          const onKey = (e) => { const k = e.key.toLowerCase(); if (k === "q") setMode(m => m === "build" ? "gadget" : "build"); if (k === "f1") setFirstPerson(v=>!v); };
          window.addEventListener("keydown", onKey);
          return () => window.removeEventListener("keydown", onKey);
        }, []);

        return React.createElement('div',{style:{width:"100%",height:"100%",position:"relative",background:"#000"}},
          React.createElement(Canvas, { shadows:true, camera:{ position:[0,2,8], fov:60 } },
            React.createElement('ambientLight',{intensity:0.6}),
            React.createElement('directionalLight',{position:[5,10,5], intensity:1.1, castShadow:true}),
            React.createElement(Sky,{distance:450000, sunPosition:[0.5,1,0.25], turbidity:4, rayleigh:2, mieCoefficient:0.01, mieDirectionalG:0.9}),
            React.createElement(Stars,{radius:100, depth:50, count:3000, factor:4, fade:true}),
            React.createElement(Ground,null),
            React.createElement(Blocks,{blocks}),
            React.createElement(PlayerController,{positionRef:playerPos, blocks, firstPerson}),
            React.createElement(CameraRig,{playerPosRef:playerPos, firstPerson}),
            firstPerson && React.createElement(PointerLockControls,{selector:"#root"}),
            React.createElement(RaycastPlacer,{mode, blocks, setBlocks}),
            React.createElement(BatarangSystem,{blocks, setBlocks})
          ),
          React.createElement('div',{className:'crosshair'}),
          React.createElement('div',{className:'topbar'},
            React.createElement('button',{className:'button', onClick:()=>setSidebarOpen(v=>!v)}, sidebarOpen?"Skjul":"Klodser (B)"),
            React.createElement('button',{className:'button', onClick:()=>setMode(m=>m==="build"?"gadget":"build")}, `Tilstand: ${mode==="build"?"Byg":"Gadget"} (Q)`),
            React.createElement('button',{className:'button', onClick:()=>setFirstPerson(v=>!v)}, firstPerson?"3rd Person (F1)":"1st Person (F1)")
          ),
          React.createElement(AnimatePresence, null,
            showHelp && React.createElement(Motion.div, {
              initial:{ opacity: 0, y: -6 },
              animate:{ opacity: 1, y: 0 },
              exit:{ opacity: 0, y: -6 },
              className:'hint'
            }, 'WASD/Pile: Bevæg • Space: Hop • B: Sidebar • 1–9: Vælg blok • Q: Byg/Gadget • E: Batarang • F1: First-person • Klik i canvas for at låse musen')
          ),
          React.createElement(Sidebar,{open:sidebarOpen, setOpen:setSidebarOpen}),
          React.createElement('div',{className:'title'},
            React.createElement('div',{style:{color:"rgba(255,255,255,.8)",fontSize:12}},'Deluxe (CDN, pinned bundled)'),
            React.createElement('div',{style:{color:"#fff", fontSize:18, fontWeight:600}},'LEGO Batman – Voxel Builder')
          )
        );
      }

      // MOUNT
      createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
  </body>
</html>
